<!DOCTYPE html>
<html lang="en-US">
<head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Risk Management System">
    <meta name="version" content="1.0">
    <meta http-equiv="Cache-control" content="public">
    <title>Asset Assessments | Risk Assessment</title>
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link href="{% static 'css/icons.css' %}" rel="stylesheet">
    <link href="{% static 'css/app-min.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'css/site_min_v7.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="assessment-view toggle-sidebar">
<header>
    <!-- Your header content here -->
</header>
<div class="admin-body" style="padding-top: 47.3854px;">
    <div class="container-fluid mrg_btm_containerfluid">
        <div class="animated fade-in">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header headingOne pl-3 border-bottom-0">
                            <div class="row align-items-center">
                                <div class="col-md-6 d-flex justify-content-start">
                                    <h5 class="card-title mt-1">ASSET ASSESSMENT</h5>
                                </div>
                            </div>
                        </div>
                        <div class="card-block">
                            <form method="post" action="{% url 'asset_assessments' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-12">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Asset</th>
                                                    <th>Asset Category</th>
                                                    <th>Criticality</th>
                                                </tr>
                                            </thead>
                                            <tbody id="asset-table-body">
                                                {% for assessment in asset_assessments %}
                                                    <tr>
                                                        <td>{{ assessment.asset }}</td>
                                                        <td>
                                                            <select name="asset_categories[]" class="form-control">
                                                                <option value="Information" {% if assessment.category == "Information" %}selected{% endif %}>Information</option>
                                                                <option value="Personal Items" {% if assessment.category == "Personal Items" %}selected{% endif %}>Personal Items</option>
                                                                <option value="Equipment" {% if assessment.category == "Equipment" %}selected{% endif %}>Equipment</option>
                                                                <option value="Systems" {% if assessment.category == "Systems" %}selected{% endif %}>Systems</option>
                                                                <option value="Services" {% if assessment.category == "Services" %}selected{% endif %}>Services</option>
                                                                <option value="Intangibles" {% if assessment.category == "Intangibles" %}selected{% endif %}>Intangibles</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-outline-secondary set-criticality-btn" data-bs-toggle="modal" data-bs-target="#popup-asset-criteria" data-row-index="{{ forloop.counter0 }}">Set Criticality</button>
                                                            <input type="hidden" name="criticalities[]" value="{{ assessment.criticality }}">
                                                            <span class="badge {% if assessment.criticality == 'Vital' %}bg-danger text-white{% elif assessment.criticality == 'Key' %}bg-warning text-white{% elif assessment.criticality == 'Important' %}bg-warning{% elif assessment.criticality == 'Supporting' %}bg-success text-white{% endif %}" id="criticality-display-{{ forloop.counter0 }}">{{ assessment.criticality }}</span>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <button type="submit" class="btn btn-primary">Next</button>
                                    </div>
                                </div>
                            </form>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <button class="btn btn-info" onclick="openAssetLibrary()">Load From Asset Library</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Asset Library Modal -->
<div id="asset-library-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="assetLibraryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assetLibraryLabel">Asset Library</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="search-asset">Search</label>
                    <input type="text" id="search-asset" class="form-control" placeholder="Search for an asset...">
                </div>
                <ul id="asset-library-list" class="list-group">
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Employees"> Employees
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Visitors"> Visitors
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Cash & Finances"> Cash & Finances
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Intellectual Property"> Intellectual Property
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Building"> Building
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Brand & Reputation"> Brand & Reputation
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Personal items"> Personal items
                    </li>
                    <li class="list-group-item">
                        <input type="checkbox" name="assets[]" value="Equipment"> Equipment
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addSelectedAssets()">Add To Assessment</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Asset Criticality Modal -->
<div id="popup-asset-criteria" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="assetCriteriaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assetCriteriaLabel">Asset Criticality</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="criticality-form" method="post" action="{% url 'save_asset_criteria' %}">
                    {% csrf_token %}
                    <input type="hidden" name="asset_index" id="asset-index">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Criticality Rating</th>
                                <th>Criteria</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="bg-danger text-white">
                                    <input type="radio" name="criticality_rating" value="Vital" id="criticality-vital">
                                    <label class="form-check-label" for="criticality-vital">Vital</label>
                                </td>
                                <td>Alternative services and/or facilities cannot be provided if asset is lost or severely damaged. Loss or compromise will result in abandonment or long-term cessation of the functions or core business practices. Loss or compromise will have a debilitating impact on the reputation of the organisation (international, permanent).</td>
                            </tr>
                            <tr>
                                <td class="bg-warning text-white">
                                    <input type="radio" name="criticality_rating" value="Key" id="criticality-key">
                                    <label class="form-check-label" for="criticality-key">Key</label>
                                </td>
                                <td>Major restrictions to core business practices will result if asset is lost or severely damaged. Loss or compromise will result in long-term cessation/disruption of core business. Loss or compromise will have a major, widespread impact on the organisation's reputation (national, sustained).</td>
                            </tr>
                            <tr>
                                <td class="bg-warning">
                                    <input type="radio" name="criticality_rating" value="Important" id="criticality-important">
                                    <label class="form-check-label" for="criticality-important">Important</label>
                                </td>
                                <td>Some minor restrictions to core business practices will result if asset is lost or severely damaged. Loss or compromise will result in short-term cessation/disruption of core business. Loss or compromise may have an impact on the organisation's reputation (regional, short-term).</td>
                            </tr>
                            <tr>
                                <td class="bg-success text-white">
                                    <input type="radio" name="criticality_rating" value="Supporting" id="criticality-supporting">
                                    <label class="form-check-label" for="criticality-supporting">Supporting</label>
                                </td>
                                <td>Business as usual services and/or facilities can be provided if asset is lost or severely damaged. Loss or compromise will not result in cessation/disruption of core business. Loss or compromise will have no discernible impact on the organisation's reputation.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save to Assessment</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openAssetLibrary() {
        $('#asset-library-modal').modal('show');
    }

    function addSelectedAssets() {
        const selectedAssets = $('#asset-library-list input[type="checkbox"]:checked').map(function() {
            return this.value;
        }).get();

        selectedAssets.forEach(asset => {
            const newRow = `
                <tr>
                    <td>${asset}</td>
                    <td>
                        <select name="asset_categories[]" class="form-control">
                            <option value="Information">Information</option>
                            <option value="Personal Items">Personal Items</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Systems">Systems</option>
                            <option value="Services">Services</option>
                            <option value="Intangibles">Intangibles</option>
                        </select>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-secondary set-criticality-btn" data-bs-toggle="modal" data-bs-target="#popup-asset-criteria" data-row-index="${$('#asset-table-body tr').length}">Set Criticality</button>
                        <input type="hidden" name="criticalities[]" value="">
                        <span class="badge" id="criticality-display-${$('#asset-table-body tr').length}"></span>
                    </td>
                </tr>
            `;
            $('#asset-table-body').append(newRow);
        });

        $('#asset-library-modal').modal('hide');
    }

    $(document).on('click', '.set-criticality-btn', function() {
        const rowIndex = $(this).data('row-index');
        $('#asset-index').val(rowIndex);
        $('#popup-asset-criteria').modal('show');
    });

    $('#criticality-form').on('submit', function(event) {
        event.preventDefault();

        const rowIndex = $('#asset-index').val();
        const selectedCriticality = $('#criticality-form input[name="criticality_rating"]:checked').val();

        $(`input[name="criticalities[]"]`).eq(rowIndex).val(selectedCriticality);
        const badge = $(`#criticality-display-${rowIndex}`);
        badge.text(selectedCriticality);

        switch (selectedCriticality) {
            case 'Vital':
                badge.attr('class', 'badge bg-danger text-white').text('Vital');
                break;
            case 'Key':
                badge.attr('class', 'badge bg-warning text-white').text('Key');
                break;
            case 'Important':
                badge.attr('class', 'badge bg-warning').text('Important');
                break;
            case 'Supporting':
                badge.attr('class', 'badge bg-success text-white').text('Supporting');
                break;
        }

        $('#popup-asset-criteria').modal('hide');
    });
</script>
</body>
</html>
